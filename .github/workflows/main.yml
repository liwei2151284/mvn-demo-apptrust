name: "mvn apptrust demo Build"

on:
  push:
    branches: [ "main" ]
  #pull_request:
    #branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: '42 11 * * 1'

permissions:
  actions: read
  contents: read
  security-events: write
  attestations: write
  id-token: write

env:
  JFrog_Mvn_Repo: "weil-mvn-virtual"
  Build_name: "mvn-apptrust-demo-build"
  Application_Key: "weil"
  Project_Key: "weil"
  JFROG_CLI_KEY_ALIAS: "weili-publickey"
  JFROG_CLI_SIGNING_KEY: ${{ secrets.JFROG_CLI_SIGNING_KEY }}



jobs:
  security-java-demo:
    name: Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'
        cache: maven

    - name: Install & Use Maven 3.8.8 (same step)
      run: |
        MAVEN_VERSION=3.8.8
        curl -fsSL https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/${MAVEN_VERSION}/apache-maven-${MAVEN_VERSION}-bin.tar.gz -o maven.tgz
        tar -xzf maven.tgz
        export PATH="$PWD/apache-maven-${MAVEN_VERSION}/bin:$PATH"
        which mvn
        mvn -v

    - name: Write PEM from secret
      run: |
        umask 077
        cat > jfrog-signing-key.pem <<'EOF'
        ${{ secrets.JFROG_CLI_SIGNING_KEY }}
        EOF
        head -n 1 jfrog-signing-key.pem
        tail -n 1 jfrog-signing-key.pem

    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4.9.1
      with:
        oidc-provider-name: ${OIDC_PROVIDER_NAME} # <owner>/<repo>@github
      env:
        # JFrog Platform url
        JF_URL: ${{ secrets.JF_URL }}
        # JFrog Platform access token
        # JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
        # JF_URL: ${{ vars.JF_URL }}


    
        #- name: Configure Supinfo CLI
        #  run: |
        #    echo $JF_TOKEN | jf c add demo --interactive=false --url=$JF_URL --access-token-stdin
        #    jf config use demo

    - name: Build Maven Project
      run: |
        export MAVEN_HOME="$GITHUB_WORKSPACE/apache-maven-3.8.8"
        export PATH="$MAVEN_HOME/bin:$PATH"
        jf -v
        jf rt ping
        sed -i "s/Version_Tag/$GITHUB_RUN_NUMBER/g" pom.xml
        jf  mvnc --repo-resolve-releases=$JFrog_Mvn_Repo --repo-resolve-snapshots=$JFrog_Mvn_Repo --repo-deploy-releases=$JFrog_Mvn_Repo --repo-deploy-snapshots=$JFrog_Mvn_Repo  
        jf  mvn -B -U clean install --build-name=$Build_name  --build-number=$GITHUB_RUN_NUMBER 

    - name: Attest build provenance (jar/war)
      uses: actions/attest-build-provenance@v3
      with:
        subject-path: |
          target/*.jar
          target/*.war

    - name: Publish Build-Info to JFrog Repo
      run: |
        jf rt bce $Build_name $GITHUB_RUN_NUMBER 
        jf rt bag $Build_name $GITHUB_RUN_NUMBER 
        jf rt bp $Build_name $GITHUB_RUN_NUMBER 

    - name: Create app version
      run: |
        jf at version-create $Application_Key $GITHUB_RUN_NUMBER --source-type-builds "name=$Build_name, id=$GITHUB_RUN_NUMBER" 
  


    - name: Extract JIRA IDs from local commit message
      id: jira
      shell: bash
      run: |
        set -euo pipefail
        MSG="$(git log -1 --pretty=%B || true)"
        echo "Commit message:"
        echo "$MSG"
        # 提取类似 ABC-123 的 Jira Key（可按需调整）
        JIRA_IDS="$(echo "$MSG" | grep -oE '[A-Z]+-[0-9]+' | sort -u | tr '\n' ' ' | xargs || true)"
        echo "jira_ids=$JIRA_IDS" >> "$GITHUB_OUTPUT"
        if [ -z "$JIRA_IDS" ]; then
          echo "No JIRA IDs found. Skip evidence."
        else
          echo "Found JIRA IDs: $JIRA_IDS"
        fi

    - name: Generate default JIRA evidence files
      if: ${{ steps.jira.outputs.jira_ids != '' }}
      shell: bash
      run: |
        set -euo pipefail
        # 转成 JSON array
        IDS_JSON=$(printf '%s\n' "${{ steps.jira.outputs.jira_ids }}" | tr ' ' '\n' | awk 'NF' | jq -R . | jq -s .)
        cat > jira-evidence-predicate.json <<EOF
        {
          "schemaVersion": "1.0",
          "type": "jira-ids-local",
          "build": {
            "name": "${Build_name}",
            "number": "${GITHUB_RUN_NUMBER}"
          },
          "jira": {
            "ids": ${IDS_JSON}
          },
          "source": {
            "repo": "${GITHUB_REPOSITORY}",
            "ref": "${GITHUB_REF}",
            "sha": "${GITHUB_SHA}",
            "run_url": "https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          },
          "created_at": "$(date -u +%FT%TZ)"
        }
        EOF
        cat > jira-evidence.md <<EOF
        ## JIRA Evidence (Local Extraction)
        This evidence is generated **without querying Jira**.
        JIRA IDs are extracted from the latest git commit message.
        - Build: \`${Build_name} #${GITHUB_RUN_NUMBER}\`
        - Repo: \`${GITHUB_REPOSITORY}\`
        - Commit: \`${GITHUB_SHA}\`
        - Run: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}
        **JIRA IDs**
        - ${{ steps.jira.outputs.jira_ids }}
        EOF

    - name: Create JIRA evidence (bind to build)
      if: ${{ steps.jira.outputs.jira_ids != '' }}
      shell: bash
      run: |
        set -euo pipefail
        jf rt ping
        jf evd create \
          --build-name "${Build_name}" \
          --build-number "${GITHUB_RUN_NUMBER}" \
          --predicate jira-evidence-predicate.json \
          --predicate-type "http://atlassian.com/jira/issues/v1" \
          --markdown jira-evidence.md \
          --provider-id jira \
          --key ./jfrog-signing-key.pem





