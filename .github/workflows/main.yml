name: "mvn apptrust demo Build"

on:
  #push:
  #  branches: [ "main" ]
  #pull_request:
    #branches: [ "main" ]
  workflow_dispatch:
    inputs:
    mode:
      description: "Select run mode"
      type: choice
      required: true
      default: build
      options:
        - "1 â€“ build without evidence "
        - "2 â€“ build with github evidence
        - "3 â€“ build with github jira evidence"
        - "4 â€“ build with github jira evidence and no critical vulns"
permissions:
  actions: read
  contents: read
  security-events: write
  attestations: write
  id-token: write

env:
  JFrog_Mvn_Repo: "weil-mvn-virtual"
  JFrog_Docker_Repo: "weil-docker-local"
  Build_name: "mvn-apptrust-demo-build"
  Application_Key: "weil"
  Project_Key: "weil"
  JFROG_CLI_KEY_ALIAS: "weili-publickey"
  JFROG_CLI_SIGNING_KEY: ${{ secrets.JFROG_CLI_SIGNING_KEY }}
  DOCKER_REGISTRY_PREFIX: "solenglatest.jfrog.io"
  APP_NAME: "mvn-apptrust-demo"



jobs:
  apptrust-java-demo-build:
    name: Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'
        cache: maven

    - name: Install & Use Maven 3.8.8 (same step)
      run: |
        MAVEN_VERSION=3.8.8
        curl -fsSL https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/${MAVEN_VERSION}/apache-maven-${MAVEN_VERSION}-bin.tar.gz -o maven.tgz
        tar -xzf maven.tgz
        export PATH="$PWD/apache-maven-${MAVEN_VERSION}/bin:$PATH"
        which mvn
        mvn -v

    - name: Write PEM from secret
      run: |
        umask 077
        cat > jfrog-signing-key.pem <<'EOF'
        ${{ secrets.JFROG_CLI_SIGNING_KEY }}
        EOF
        head -n 1 jfrog-signing-key.pem
        tail -n 1 jfrog-signing-key.pem

    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4.9.1
      with:
        oidc-provider-name: liwei2151284/mvn-demo-apptrust@github
      env:
        # JFrog Platform url
        JF_URL: ${{ secrets.JF_URL }}
        # JFrog Platform access token
        # JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
        # JF_URL: ${{ vars.JF_URL }}


    
        #- name: Configure Supinfo CLI
        #  run: |
        #    echo $JF_TOKEN | jf c add demo --interactive=false --url=$JF_URL --access-token-stdin
        #    jf config use demo

    - name: Fix fastjson vuln version
      if: ${{ startsWith(inputs.mode, '4')}}
      run: |
        sed -i "s/1.2.31/1.2.83/g" pom.xml
        sed -i "s/2.12.1/2.16.0/g" pom.xml


    - name: Build Maven Project
      run: |
        export MAVEN_HOME="$GITHUB_WORKSPACE/apache-maven-3.8.8"
        export PATH="$MAVEN_HOME/bin:$PATH"
        jf -v
        jf rt ping
        sed -i "s/Version_Tag/$GITHUB_RUN_NUMBER/g" pom.xml

        mvn -B -U clean install

        # Skip jf
        # jf  mvnc --repo-resolve-releases=$JFrog_Mvn_Repo --repo-resolve-snapshots=$JFrog_Mvn_Repo --repo-deploy-releases=$JFrog_Mvn_Repo --repo-deploy-snapshots=$JFrog_Mvn_Repo  
        # jf  mvn -B -U clean install --build-name=$Build_name  --build-number=$GITHUB_RUN_NUMBER 


    - name: Build Docker Project and Push Docker image
      id: build-and-push
      run: |
        jf docker  build  \
          --tag $DOCKER_REGISTRY_PREFIX/$JFrog_Docker_Repo/$APP_NAME:$GITHUB_RUN_NUMBER  \
          --metadata-file=build-metadata --output=type=image --push .
        jf rt build-docker-create $JFrog_Docker_Repo \
          --image-file build-metadata --build-name $Build_name --build-number $GITHUB_RUN_NUMBER

        DIGEST=$(jq -r '.["containerimage.digest"]' build-metadata)
        echo "digest=$DIGEST" >> $GITHUB_OUTPUT
        echo "Extracted digest: $DIGEST"


    - name: Attest Docker Image with Build Provenance
      if: ${{ startsWith(inputs.mode, '2') ||startsWith(inputs.mode, '3') ||startsWith(inputs.mode, '4')}}
      uses: actions/attest-build-provenance@v3
      with:
        # The 'oci://' prefix is required by JFrog to correctly parse the artifact type
        subject-name: oci://${{ env.DOCKER_REGISTRY_PREFIX }}/${{ env.JFrog_Docker_Repo }}/${{ env.APP_NAME }}:${{ github.run_number }}
        subject-digest: ${{ steps.build-and-push.outputs.digest }}


    - name: Publish Build-Info to JFrog Repo
      run: |
        jf rt bce $Build_name $GITHUB_RUN_NUMBER 
        jf rt bag $Build_name $GITHUB_RUN_NUMBER 
        jf rt bp $Build_name $GITHUB_RUN_NUMBER 

    - name: Extract JIRA IDs from local commit message
      id: jira
      shell: bash
      run: |
        set -euo pipefail
        MSG="$(git log -1 --pretty=%B || true)"
        echo "Commit message:"
        echo "$MSG"
        # æå–ç±»ä¼¼ ABC-123 çš„ Jira Keyï¼ˆå¯æŒ‰éœ€è°ƒæ•´ï¼‰
        JIRA_IDS="$(echo "$MSG" | grep -oE '[A-Z]+-[0-9]+' | sort -u | tr '\n' ' ' | xargs || true)"
        echo "jira_ids=$JIRA_IDS" >> "$GITHUB_OUTPUT"
        if [ -z "$JIRA_IDS" ]; then
          echo "No JIRA IDs found. Skip evidence."
        else
          echo "Found JIRA IDs: $JIRA_IDS"
        fi

    - name: Generate default JIRA evidence files
      if: ${{ steps.jira.outputs.jira_ids != '' }}
      shell: bash
      run: |
        set -euo pipefail
        # è½¬æˆ JSON array
        IDS_JSON=$(printf '%s\n' "${{ steps.jira.outputs.jira_ids }}" | tr ' ' '\n' | awk 'NF' | jq -R . | jq -s .)
        cat > jira-evidence-predicate.json <<EOF
        {
          "schemaVersion": "1.0",
          "type": "jira-ids-local",
          "build": {
            "name": "${Build_name}",
            "number": "${GITHUB_RUN_NUMBER}"
          },
          "jira": {
            "ids": ${IDS_JSON}
          },
          "source": {
            "repo": "${GITHUB_REPOSITORY}",
            "ref": "${GITHUB_REF}",
            "sha": "${GITHUB_SHA}",
            "run_url": "https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          },
          "created_at": "$(date -u +%FT%TZ)"
        }
        EOF
        cat > jira-evidence.md <<EOF
        ## JIRA Evidence (Local Extraction)
        This evidence is generated **without querying Jira**.
        JIRA IDs are extracted from the latest git commit message.
        - Build: \`${Build_name} #${GITHUB_RUN_NUMBER}\`
        - Repo: \`${GITHUB_REPOSITORY}\`
        - Commit: \`${GITHUB_SHA}\`
        - Run: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}
        **JIRA IDs**
        - ${{ steps.jira.outputs.jira_ids }}
        EOF

    #- name: Create JIRA evidence (bind to build)
    #  if: ${{ steps.jira.outputs.jira_ids != '' }}
    #  shell: bash
    #  run: |
    #    set -euo pipefail
    #    jf rt ping
    #    jf evd create \
    #      --build-name "${Build_name}" \
    #      --build-number "${GITHUB_RUN_NUMBER}" \
    #      --predicate jira-evidence-predicate.json \
    #      --predicate-type "http://atlassian.com/jira/issues/v1" \
    #      --markdown jira-evidence.md \
    #      --provider-id jira \
    #      --key ./jfrog-signing-key.pem



    - name: Evidence on docker image
      if: ${{ startsWith(inputs.mode, '3') ||startsWith(inputs.mode, '4')}}
      if: ${{ steps.jira.outputs.jira_ids != '' }}
      shell: bash
      run: |
        set -euo pipefail
        echo "ðŸ” Creating evidence on docker image..."
        jf evd create --subject-repo-path $JFrog_Docker_Repo/$APP_NAME/$GITHUB_RUN_NUMBER/manifest.json  \
          --project $Project_Key --predicate ./jira-evidence-predicate.json --predicate-type "http://atlassian.com/jira/issues/v1" \
          --markdown ./jira-evidence.md --provider-id jira --key ./jfrog-signing-key.pem


  apptrust-java-demo-create-apptrust-version:
    name: Build
    runs-on: ubuntu-latest
    needs: apptrust-java-demo-build

    steps:

    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4.9.1
      with:
        oidc-provider-name: liwei2151284/mvn-demo-apptrust@github
      env:
        # JFrog Platform url
        JF_URL: ${{ secrets.JF_URL }}  

    - name: Create app version
      run: |
        jf at version-create $Application_Key $GITHUB_RUN_NUMBER --source-type-builds "name=$Build_name, id=$GITHUB_RUN_NUMBER" 

 